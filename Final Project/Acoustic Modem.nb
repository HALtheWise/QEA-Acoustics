(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.4' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     15425,        515]
NotebookOptionsPosition[     12869,        419]
NotebookOutlinePosition[     13212,        434]
CellTagsIndexPosition[     13169,        431]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Comms final project: Acoustic Modem", "Title",
 CellChangeTimes->{{3.6826813785335817`*^9, 3.682681379590159*^9}, {
  3.682710876474948*^9, 3.682710892530466*^9}, {3.682980932118884*^9, 
  3.682980953632352*^9}, {3.6832870653509636`*^9, 3.6832870854599743`*^9}, {
  3.6832873288913145`*^9, 3.6832873404404697`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "@", 
   RowBox[{"NotebookDirectory", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"<<", "\"\<../MMA library.m\>\""}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.682710916634346*^9, 3.682710945444784*^9}, {
  3.682711378657494*^9, 3.682711389969411*^9}}],

Cell[CellGroupData[{

Cell["Shared constants", "Section",
 CellChangeTimes->{{3.6832875389373174`*^9, 3.6832875420816317`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Global`databaud", " ", "=", " ", 
    TemplateBox[{"10","\"Hz\"","hertz","\"Hertz\""},
     "Quantity"]}], ";"}], 
  RowBox[{"(*", " ", "hertz", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Global`speakerbaud", " ", "=", " ", 
    TemplateBox[{"40000","\"Hz\"","hertz","\"Hertz\""},
     "Quantity"]}], ";"}], 
  RowBox[{"(*", " ", "hertz", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Global`carrierfreq", "=", 
    TemplateBox[{"500","\"Hz\"","hertz","\"Hertz\""},
     "Quantity"]}], ";"}], 
  RowBox[{"(*", " ", "hertz", " ", "*)"}]}]}], "Input",
 CellChangeTimes->{{3.683287543924816*^9, 3.683287605911014*^9}, {
  3.6832876485882816`*^9, 3.683287702112633*^9}, {3.6832877420886307`*^9, 
  3.683287760777499*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Transmitter", "Section",
 GeneratedCell->True,
 CellAutoOverwrite->True,
 CellChangeTimes->{3.683287430332458*^9}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"context", "=", "\"\<tx`\>\""}], "}"}], ",", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Context", "[", "]"}], " ", "\[NotEqual]", " ", "context"}], 
      ",", 
      RowBox[{"Begin", "[", "context", "]"}]}], "]"}]}], "]"}], ";", 
  RowBox[{"Dynamic", "[", 
   RowBox[{"Refresh", "[", 
    RowBox[{
     RowBox[{"Context", "[", "]"}], ",", 
     RowBox[{"UpdateInterval", "\[Rule]", "1"}]}], "]"}], "]"}]}]], "Input",
 GeneratedCell->True,
 CellAutoOverwrite->True,
 CellChangeTimes->{3.683287430333458*^9}],

Cell[BoxData[
 DynamicBox[ToBoxes[
   Refresh[
    Context[], UpdateInterval -> 1], StandardForm],
  ImageSizeCache->{21., {0., 9.}}]], "Output",
 CellChangeTimes->{{3.6832874303354588`*^9, 3.683287437226147*^9}, 
   3.683288976625736*^9, 3.6832902466271305`*^9, {3.6832902850881305`*^9, 
   3.6832902897141304`*^9}, 3.6832910728252954`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 1: Generate signal codes", "Subsection",
 CellChangeTimes->{{3.6832874303384585`*^9, 3.683287485779002*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"codeLen", "=", 
   RowBox[{"speakerbaud", "/", "databaud"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6832878412795486`*^9, 3.683287864545875*^9}}],

Cell["\<\
The codes are still complex at this point, and will only be transformed to \
real space before being played.\
\>", "Text",
 CellChangeTimes->{{3.68328790299572*^9, 3.6832879282152414`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"baseCode", " ", "=", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"Exp", "[", 
      RowBox[{"I", " ", "2", "Pi", " ", 
       RowBox[{"QuantityMagnitude", "@", "carrierfreq"}], " ", "#"}], "]"}], 
     "&"}], "/@", 
    RowBox[{"N", "@", 
     RowBox[{"Range", "[", 
      RowBox[{"0", ",", 
       RowBox[{"1", "/", 
        RowBox[{"QuantityMagnitude", "@", "databaud"}]}], ",", 
       RowBox[{"1", "/", 
        RowBox[{"QuantityMagnitude", "@", "speakerbaud"}]}]}], "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"codes", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"baseCode", "*", 
      RowBox[{"Exp", "[", 
       RowBox[{"#", " ", "I"}], "]"}]}], "&"}], "/@", 
    RowBox[{"{", 
     RowBox[{"0", ",", "Pi"}], "}"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.6832878230457253`*^9, 3.6832878254189625`*^9}, {
  3.6832878906134815`*^9, 3.6832878932117414`*^9}, {3.683287933052725*^9, 
  3.68328805851427*^9}, {3.683288105199736*^9, 3.683288144851736*^9}, {
  3.6832881842847357`*^9, 3.683288212465736*^9}, {3.6832882879867363`*^9, 
  3.6832883277047358`*^9}, {3.683288991190736*^9, 3.683289062324736*^9}, {
  3.6832891202340417`*^9, 3.683289162335251*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 2: Retrieve data to transmit", "Subsection",
 CellChangeTimes->{{3.6832874694333677`*^9, 3.683287494997924*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"rawdata", "=", "\"\<a-z\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.6832892655645733`*^9, 3.6832892844914656`*^9}, {
  3.6832895381278267`*^9, 3.683289538285843*^9}, {3.6832902531881304`*^9, 
  3.6832902545311303`*^9}, {3.6832903065661306`*^9, 3.6832903105971303`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 3: Convert data to symbols", "Subsection",
 CellChangeTimes->{{3.683287497098134*^9, 3.683287505773001*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"bytes", "=", 
   RowBox[{"ToCharacterCode", "@", "rawdata"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"symbols", "=", 
   RowBox[{"Flatten", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"IntegerDigits", "[", 
       RowBox[{"#", ",", "2", ",", "8"}], "]"}], "&"}], "/@", "bytes"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Append", "[", 
  RowBox[{
   RowBox[{"symbols", "[", 
    RowBox[{"[", 
     RowBox[{"1", ";;", "10"}], "]"}], "]"}], ",", "\"\<...\>\""}], 
  "]"}]}], "Input",
 CellChangeTimes->{{3.6832892901300297`*^9, 3.683289317486765*^9}, {
  3.683289426920707*^9, 3.6832895837293863`*^9}, {3.6832910644384565`*^9, 
  3.6832910645254655`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", 
   ",", "0", ",", "0", ",", "\<\"...\"\>"}], "}"}]], "Output",
 CellChangeTimes->{{3.6832894888539*^9, 3.6832895843164454`*^9}, {
   3.6832902467861304`*^9, 3.68329028523213*^9}, 3.6832903180231304`*^9, {
   3.6832910651065235`*^9, 3.6832910729583087`*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 4: Interleave transmit codes", "Subsection",
 CellChangeTimes->{{3.683287508639288*^9, 3.6832875153889627`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"signal", "=", 
   RowBox[{"Flatten", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"codes", "[", 
       RowBox[{"[", 
        RowBox[{"#", "+", "1"}], "]"}], "]"}], "&"}], "/@", "symbols"}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6832896041284266`*^9, 3.683289647049718*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 5: Transmit and save", "Subsection",
 CellChangeTimes->{{3.683287517913215*^9, 3.6832875221366377`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"sound", "=", 
   RowBox[{"SampledSoundList", "[", 
    RowBox[{
     RowBox[{"Re", "@", "signal"}], ",", 
     RowBox[{"QuantityMagnitude", "@", "speakerbaud"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6832898991129217`*^9, 3.6832899723882484`*^9}, 
   3.6832902355581303`*^9}],

Cell[BoxData[
 RowBox[{"EmitSound", "[", "sound", "]"}]], "Input",
 CellChangeTimes->{{3.683289654034416*^9, 3.6832897266566777`*^9}, {
  3.6832899750975194`*^9, 3.683289998117821*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Export", "[", 
  RowBox[{"\"\<test data\\output.wav\>\"", ",", "sound"}], "]"}]], "Input",
 CellChangeTimes->{{3.6832898427072816`*^9, 3.683289843642375*^9}, {
  3.6832900052395334`*^9, 3.683290039747984*^9}},
 EmphasizeSyntaxErrors->True],

Cell[BoxData["\<\"test data\\\\output.wav\"\>"], "Output",
 CellChangeTimes->{{3.6832900199470043`*^9, 3.6832900402130303`*^9}, {
   3.6832902469721303`*^9, 3.68329031818513*^9}, 3.68329107317433*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Cleanup", "Subsection",
 CellChangeTimes->{{3.6832897656275744`*^9, 3.6832897685428658`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"With", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"context", "=", "\"\<tx`\>\""}], "}"}], ",", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Context", "[", "]"}], "\[Equal]", "context"}], ",", 
     RowBox[{"End", "[", "]"}], ",", "\"\<Not in context\>\""}], "]"}]}], 
  "]"}]], "Input",
 GeneratedCell->True,
 CellAutoOverwrite->True,
 CellChangeTimes->{3.6832874303394585`*^9}],

Cell[BoxData["\<\"tx`\"\>"], "Output",
 CellChangeTimes->{3.6832910731873317`*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Receiver", "Section",
 CellChangeTimes->{{3.6832903627421303`*^9, 3.68329037494013*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"context", "=", "\"\<rx`\>\""}], "}"}], ",", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Context", "[", "]"}], " ", "\[NotEqual]", " ", "context"}], 
      ",", 
      RowBox[{"Begin", "[", "context", "]"}]}], "]"}]}], "]"}], ";", 
  RowBox[{"Dynamic", "[", 
   RowBox[{"Refresh", "[", 
    RowBox[{
     RowBox[{"Context", "[", "]"}], ",", 
     RowBox[{"UpdateInterval", "\[Rule]", "1"}]}], "]"}], "]"}]}]], "Input",
 GeneratedCell->True,
 CellAutoOverwrite->True,
 CellChangeTimes->{3.6832903627431307`*^9}],

Cell[BoxData[
 DynamicBox[ToBoxes[
   Refresh[
    Context[], UpdateInterval -> 1], StandardForm],
  ImageSizeCache->{21., {0., 9.}}]], "Output",
 CellChangeTimes->{{3.6832903627451305`*^9, 3.6832903838611307`*^9}, {
  3.6832910819862113`*^9, 3.6832911038403964`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Read in the audio data", "Subsection",
 CellChangeTimes->{{3.6832904035551305`*^9, 3.6832904137781305`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"inputSound", "=", 
   RowBox[{"Import", "[", 
    RowBox[{"\"\<test data/output.wav\>\"", ",", "\"\<Data\>\""}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6832904165821304`*^9, 3.6832905281511307`*^9}, {
  3.68329059660713*^9, 3.6832906875771303`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Find the agreed-upon start code, then crop to it", "Subsection",
 CellChangeTimes->{{3.6832906927401304`*^9, 3.6832907166431303`*^9}}],

Cell["TODO: do this", "Text",
 CellChangeTimes->{{3.6832907504331303`*^9, 3.68329075445413*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"croppedsound", "=", "inputSound"}], ";"}]], "Input",
 CellChangeTimes->{{3.6832907371151304`*^9, 3.6832907570971303`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Chop the sound into databaud long segments", "Subsection",
 CellChangeTimes->{{3.68329072004613*^9, 3.68329073225813*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"segments", "=", 
   RowBox[{"Partition", "[", 
    RowBox[{"croppedsound", ",", 
     RowBox[{"speakerbaud", "/", "databaud"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"Dimensions", "@", "segments"}]}], "Input",
 CellChangeTimes->{{3.6832908368191304`*^9, 3.6832908400091305`*^9}, {
  3.6832908783591304`*^9, 3.68329096201313*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"24", ",", "4000"}], "}"}]], "Output",
 CellChangeTimes->{{3.6832909150691304`*^9, 3.68329096240913*^9}, {
  3.6832910820682197`*^9, 3.68329110617563*^9}}]
}, Open  ]]
}, Open  ]],

Cell["...", "Subsection",
 CellChangeTimes->{{3.6832911735743694`*^9, 3.683291175832595*^9}, {
  3.683291257619773*^9, 3.6832912587618876`*^9}}],

Cell[CellGroupData[{

Cell["Cleanup", "Subsection",
 CellChangeTimes->{{3.6832905377471304`*^9, 3.68329054079613*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"With", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"context", "=", "\"\<rx`\>\""}], "}"}], ",", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Context", "[", "]"}], "\[Equal]", "context"}], ",", 
     RowBox[{"End", "[", "]"}], ",", "\"\<Not in context\>\""}], "]"}]}], 
  "]"}]], "Input",
 GeneratedCell->True,
 CellAutoOverwrite->True,
 CellChangeTimes->{3.6832903627491302`*^9}],

Cell[BoxData["\<\"rx`\"\>"], "Output",
 CellChangeTimes->{{3.6832903627521305`*^9, 3.6832903816691303`*^9}, 
   3.6832910820772204`*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{960, 1004},
WindowMargins->{{426, Automatic}, {Automatic, 0}},
FrontEndVersion->"11.0 for Microsoft Windows (64-bit) (July 28, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 321, 4, 101, "Title"],
Cell[904, 28, 331, 7, 66, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[1260, 39, 105, 1, 70, "Section"],
Cell[1368, 42, 820, 21, 112, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[2225, 68, 120, 3, 70, "Section"],
Cell[CellGroupData[{
Cell[2370, 75, 625, 19, 50, "Input"],
Cell[2998, 96, 341, 7, 30, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[3376, 108, 119, 1, 49, "Subsection"],
Cell[3498, 111, 182, 4, 30, "Input"],
Cell[3683, 117, 199, 4, 30, "Text"],
Cell[3885, 123, 1222, 31, 69, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[5144, 159, 123, 1, 49, "Subsection"],
Cell[5270, 162, 307, 5, 30, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[5614, 172, 119, 1, 49, "Subsection"],
Cell[CellGroupData[{
Cell[5758, 177, 723, 21, 69, "Input"],
Cell[6484, 200, 375, 7, 30, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[6908, 213, 123, 1, 49, "Subsection"],
Cell[7034, 216, 326, 10, 30, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[7397, 231, 115, 1, 49, "Subsection"],
Cell[7515, 234, 325, 9, 30, "Input"],
Cell[7843, 245, 185, 3, 30, "Input"],
Cell[CellGroupData[{
Cell[8053, 252, 263, 5, 30, "Input"],
Cell[8319, 259, 200, 2, 30, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[8568, 267, 99, 1, 49, "Subsection"],
Cell[CellGroupData[{
Cell[8692, 272, 426, 13, 30, "Input"],
Cell[9121, 287, 82, 1, 30, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[9264, 295, 94, 1, 70, "Section"],
Cell[CellGroupData[{
Cell[9383, 300, 627, 19, 50, "Input"],
Cell[10013, 321, 268, 6, 30, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[10318, 332, 114, 1, 49, "Subsection"],
Cell[10435, 335, 296, 7, 30, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[10768, 347, 140, 1, 49, "Subsection"],
Cell[10911, 350, 96, 1, 30, "Text"],
Cell[11010, 353, 157, 3, 30, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[11204, 361, 128, 1, 49, "Subsection"],
Cell[CellGroupData[{
Cell[11357, 366, 381, 9, 50, "Input"],
Cell[11741, 377, 194, 4, 30, "Output"]
}, Open  ]]
}, Open  ]],
Cell[11962, 385, 144, 2, 49, "Subsection"],
Cell[CellGroupData[{
Cell[12131, 391, 96, 1, 41, "Subsection"],
Cell[CellGroupData[{
Cell[12252, 396, 426, 13, 30, "Input"],
Cell[12681, 411, 136, 2, 30, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

